<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">
<title>SuccessRiver CareerChart</title>
<style>
*,*::before,*::after{box-sizing:border-box}ul[class],ol[class]{padding:0}body,h1,h2,h3,h4,p,ul[class],ol[class],figure,blockquote,dl,dd{margin:0}html{scroll-behavior:smooth}body{min-height:100vh;text-rendering:optimizeSpeed;line-height:1.5}ul[class],ol[class]{list-style:none}a:not([class]){text-decoration-skip-ink:auto}img,picture{max-width:100%;display:block}article>*+*{margin-top:1em}input,button,textarea,select{font:inherit}@media(prefers-reduced-motion:reduce){*{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important;scroll-behavior:auto !important}}
* {
  font-feature-settings: "palt";
  font-family: sans-serif;
}
:root {
  --col-width: 50px;
}
.clearfix::after {
   content: "";
   display: block;
   clear: both;
}
.app > div {
  margin: 20px;
}
.career-chart {
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 5px;
}
.achievement-chart,
.edujob-chart,
.grant-chart,
.year-chart {
  padding: 10px 0;
}
.edujob-row,
.grant-row {
  position: relative;
  height: 30px;
}
.edujob-cell,
.grant-cell {
  position: absolute;
  display: flex;
  height: 25px;
  padding: 0 0 3px;
  font-size: 0.8em;
  line-height: 1em;
  border: 1px solid orange;
  border-width: 0 0 5px;
  overflow: hidden;
}
.edujob-cell.edu-cell { border-color: orange;      }
.edujob-cell.job-cell { border-color: orangered;   }
.grant-cell.isPI      { border-color: forestgreen; }
.grant-cell.isnotPI   { border-color: lightgreen;  }
.edujob-cell span,
.grant-cell span {
  display: inline-block;
  margin: 0 auto;
  align-self: flex-end;
  text-align: left;
  white-space: nowrap;
}
.achievement-row {
  height: 100px;
}
.achievement-col {
  float: left;
  display: flex;
  flex-direction: column-reverse;
  width: calc(var(--col-width) - 4px);
  height: 100px;
  margin: 0 4px 0 0;
}
.achievement-cell {
  width: 100%;
  height: 5px;
  margin: 1px 0 0;
  align-self: flex-end;
}
.achievement-cell.item-first-or-corresp { background: blueviolet; }
.achievement-cell.item-other            { background: violet;     }
.year-cell {
  float: left;
  display: block;
  width: calc(var(--col-width) - 4px);
  margin: 0 4px 0 0;
  padding: 5px 0 0;
  font-size: 0.8em;
  line-height: 1em;
  text-align: center;
  border: 1px solid gray;
  border-width: 5px 0 0;
}
.year-cell.now {
  width: 100px;
  border: 1px solid #ddd;
  border-width: 5px 0 0;
}
</style>
<div class="app" id="app">
<h1>SuccessRiver CareerChart</h1>
<div class="file-upload">
  <div v-if="rmFile == null">
    <h2>researchmapのエクスポートファイルを選択</h2>
    <input type="file" id="researchmap-file-input" @change="selectrmFile"></li>
  </div>
  <div v-else>
    ${ rmFile.name }
    <span @click="rmFile = null">ファイルを変更する</span>
  </div>
</div>
<div class="display-option">
  <h2>表示オプション</h2>
</div>
<div>
  <h2>キャリアチャート</h2>
  <div class="career-chart" v-if="career.latestYear">
    <div class="achievement-chart">
      <div class="achievement-row">
        <div class="achievement-col"
             v-for="(col, i) in chart.achievements.journal">
          <span class="achievement-cell"></span>
          <span class="achievement-cell"
                v-for="item in col"
                :class="{'item-first-or-corresp': item == 1, 'item-other': item == 0}"></span>
        </div>
      </div>
    </div>
    <div class="grant-chart">
      <div class="grant-row"
           v-for="(row, i) in chart.grants.slice().reverse()">
        <span class="grant-cell"
              v-for="(item, j) in row"
              :class="{'isPI': item.isPI, 'isnotPI': !item.isPI}"
              :style="getStackCellStyle(item)">
          <span v-html="item.name"></span>
        </span>
      </div>
    </div>
    <div class="edujob-chart">
      <div class="edujob-row"
           v-for="(row, i) in chart.educationsAndJobs.slice().reverse()">
        <span class="edujob-cell"
              v-for="(item, j) in row"
              :class="{'edu-cell': item.isEdu, 'job-cell': !item.isEdu}"
              :style="getStackCellStyle(item)">
          <span v-html="item.name"></span>
        </span>
      </div>
    </div>
    <div class="year-chart clearfix">
      <span class="year-cell"
            v-for="i in (career.latestYear - career.firstYear + 1)">${ career.firstYear + i - 1}</span>
      <span class="year-cell now"></span>
    </div>
  </div>
</div>
<div class="career-data">
  <h2>キャリアデータ</h2>
  <h3>研究者情報</h3>
  ${ researcher }<br>
  ${ career.firstYear } 〜 ${ career.latestYear }
  <h3>業績 (total: ${career.achievements.total})</h3>
  <h4>ジャーナル・論文誌 (total: ${career.achievements.journal.total})</h4>
    <ul>
      <li v-for="(item, year) in career.achievements.journal" v-if="year != 'total'">
        ${year} ... firstCorresp: ${item.firstCorresp}, first: ${item.first}, corresp: ${item.corresp}, other: ${item.other} (total: ${item.total})
      </li>
    </ul>
  <h4>国際会議 (total: ${career.achievements.intlConf.total})</h4>
    <ul>
      <li v-for="(item, year) in career.achievements.intlConf" v-if="year != 'total'">
        ${year} ... firstCorresp: ${item.firstCorresp}, first: ${item.first}, corresp: ${item.corresp}, other: ${item.other} (total: ${item.total})
      </li>
    </ul>
  <h4>国内研究会・シンポジウム (total: ${career.achievements.domesticConf.total})</h4>
    <ul>
      <li v-for="(item, year) in career.achievements.domesticConf" v-if="year != 'total'">
        ${year} ... firstCorresp: ${item.firstCorresp}, first: ${item.first}, corresp: ${item.corresp}, other: ${item.other} (total: ${item.total})
      </li>
    </ul>
  <h3>予算獲得状況</h3>
  ${ career.grants }
  <h3>学歴・職歴</h3>
  ${ career.educationsAndJobs }
  <h3>rawJson</h3>
  ${ rmJson }
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script>
const $ = (id) => { return document.getElementById(id); }
const JSONL = {
  parse: (jsonl) => {
    let jsonlArray = jsonl.split("\n").filter(function (s) { return s !== ""; });
     let jsonlObj = {}
    for(let i=0; i < jsonlArray.length; i++) {
      jsonlRow = JSON.parse(jsonlArray[i]);
       if(!(jsonlRow.insert.type in jsonlObj)) {
         jsonlObj[jsonlRow.insert.type] = [];
       }
      jsonlObj[jsonlRow.insert.type].push(jsonlRow.merge);
    }
    return jsonlObj;
  }
}
var app = new Vue({
  delimiters: ['${', '}'],
  el: '#app',
  data: {
    rmFile: null,
    rmJson: null,
    researcher: {
      name: {
        ja: [],
        en: [],
      }
    },
    career: {
      firstYear: new Date().getFullYear(),
      latestYear: 0,
      educationsAndJobs: [],
      grants: [],
      achievements: {
        journal:      {total: 0},
        intlConf:     {total: 0},
        domesticConf: {total: 0},
        total: 0,
      }
    },
    chart: {
      setting: {
        cellWidth: 50,
      },
      educationsAndJobs: [],
      grants: [],
      achievements: {
        journal:      [],
        intlConf:     [],
        domesticConf: [],
      },
    }
  },
  created: function() {
  },
  mounted: function() {
  },
  destroyed: function () {
  },
  methods: {
    selectrmFile: function(e) {
      const files = e.target.files || e.dataTransfer.files;
      this.rmFile = (files[0].name.split('.').pop() == 'jsonl') ? files[0] : null;
      var reader = new FileReader();
      reader.readAsText(this.rmFile);
      reader.onload = () => {  
        this.rmJson = JSONL.parse(reader.result);
        this.parseCareerHistory();
        this.plotCareerHistory();
      };
    },
    parseCareerHistory() {
      // Basic Info
      if('researchers' in this.rmJson) {
        let researcher = this.rmJson.researchers[0];
        this.researcher.name.ja = [
          researcher.family_name.ja + " " + researcher.given_name.ja,
          researcher.family_name.ja +       researcher.given_name.ja,
        ];
        this.researcher.name.en = [
          researcher.family_name.en + " " + researcher.given_name.en,
          researcher.given_name.en  + " " + researcher.family_name.en,
        ];
      }
      // Education History
      for(let i=0; i < this.rmJson.education.length; i++) {
        let edu = this.rmJson.education[i];
        let yearFrom = this.getFinancialYear(edu.from_date);
        let yearTo   = this.getFinancialYear(edu.to_date);
        let eduName  = '';
        if('course' in edu) {
          eduName = this.getEduName(edu.course);
        }
        if(eduName == '' && 'department' in edu) {
          eduName = this.getEduName(edu.department);
        }
        this.career.educationsAndJobs.push({'yearFrom': yearFrom, 'yearTo': yearTo, 'name': eduName, 'isEdu': true});
        this.updateCareerPeriod(yearFrom.year, yearTo.year);
      }
      // Job History
      for(let i=0; i < this.rmJson.research_experience.length; i++) {
        let job = this.rmJson.research_experience[i];
        let yearFrom = this.getFinancialYear(job.from_date);
        let yearTo   = this.getFinancialYear(job.to_date);
        let jobName  = ('job' in job) ? this.getJobName(job) : '';
        this.career.educationsAndJobs.push({'yearFrom': yearFrom, 'yearTo': yearTo, 'name': jobName, 'isEdu': false});
        this.updateCareerPeriod(yearFrom.year, yearTo.year);
      }
      // Grant History
      for(let i=0; i < this.rmJson.research_projects.length; i++) {
        let grant = this.rmJson.research_projects[i];
        let yearFrom  = this.getFinancialYear(grant.from_date);
        let yearTo    = this.getFinancialYear(grant.to_date);
        let grantName = this.getGrantName(grant);
        let grantRole = !('research_project_owner_role' in grant) ? 'undefined'
                      : grant.research_project_owner_role == 'principal_investigator' ? 'principal'
                      : grant.research_project_owner_role == 'coinvestigator' ? 'coinvestigator'
                      : 'others';
        this.career.grants.push({'yearFrom': yearFrom, 'yearTo': yearTo, 'name': grantName, 'role': grantRole});
        this.updateCareerPeriod(yearFrom.year, yearTo.year);
      }
      // Achievement History (paper)
      for(let i=0; i < this.rmJson.published_papers.length; i++) {
        let achvmnt = this.rmJson.published_papers[i];
        if ('published_paper_type' in achvmnt) {
          let achvmntType = achvmnt.published_paper_type == 'scientific_journal' ? 'journal'
                          : achvmnt.published_paper_type == 'international_conference_proceedings' ? 'intlConf'
                          : achvmnt.published_paper_type == 'symposium' ? 'domesticConf'
                          : '';
          if(achvmntType != '') {
            let firstAuthorFlag = false;
            let correspAuthorFlag = false;
            if('published_paper_owner_roles' in achvmnt) {
              firstAuthorFlag = achvmnt.published_paper_owner_roles.includes('lead');
              correspAuthorFlag = achvmnt.published_paper_owner_roles.includes('corresponding');
            }
            if(!firstAuthorFlag && 'en' in achvmnt.authors) {
              firstAuthorFlag = this.researcher.name.en.includes(achvmnt.authors.en[0].name);
            }
            if(!firstAuthorFlag && 'ja' in achvmnt.authors) {
              firstAuthorFlag = this.researcher.name.ja.includes(achvmnt.authors.ja[0].name);
            }
            achvmntYear = this.getFinancialYear(achvmnt.publication_date).year;
            if(!(achvmntYear in this.career.achievements[achvmntType])) {
              this.career.achievements[achvmntType][achvmntYear] = {'firstCorresp': 0, 'first': 0, 'corresp': 0, 'other': 0, 'total': 0};
            }
            let roleKey = (firstAuthorFlag && correspAuthorFlag) ? 'firstCorresp'
                        : firstAuthorFlag ? 'first'
                        : correspAuthorFlag ? 'corresp'
                        : 'other'
            this.career.achievements[achvmntType][achvmntYear][roleKey]++;
            this.career.achievements[achvmntType][achvmntYear].total++;
            this.career.achievements[achvmntType].total++;
            this.career.achievements.total++;
            this.updateCareerPeriod(achvmntYear, achvmntYear);
          }
        }
      }
    },
    getFinancialYear(targetDate, isFrom) {
      if(targetDate == "9999"){
        return {'year': new Date().getFullYear() + 1, 'month': isFrom ? 4 : 3};
      }
      dt = targetDate.split('-');
      year  = (dt.length > 0) ? parseInt(dt[0]) : new Date.now().getYear();
      month = (dt.length > 1) ? parseInt(dt[1]) : isFrom ? 4 : 3;
      return {'year': year, 'month': month}
    },
    updateCareerPeriod(yearFrom, yearTo) {
      if(this.career.firstYear  > yearFrom) { this.career.firstYear  = yearFrom; }
      if(this.career.latestYear < yearTo  ) { this.career.latestYear = Math.min(new Date().getFullYear(), yearTo);   }
    },
    getEduName(edu) {
      if     (edu.ja.includes("修士"))       { return '修士課程' }
      else if(edu.ja.includes("修士課程"))    { return '修士課程' }
      else if(edu.ja.includes("博士前期課程")) { return '博士前期課程' }
      else if(edu.ja.includes("博士後期課程")) { return '博士後期課程' }
      else if(edu.ja.includes("博士課程"))    { return '博士課程' }
      else if(edu.ja.includes("博士"))       { return '博士課程' }
      else if(edu.ja.includes("研究科"))     { return '大学院' }
      else                                  { return '-' }
    },
    getJobName(job) {
      if('affiliation' in job) {
        jobName = job.affiliation.ja + "・" + job.job.ja;
      } else {
        jobName = job.job.ja;
      }
      if(jobName.includes("日本学術振興会")) {
        jobName = jobName.includes("DC1") ? "学振DC1"
                : jobName.includes("DC2") ? "学振DC2"
                : jobName.includes("RPD") ? "学振RPD"
                : jobName.includes("SPD") ? "学振SPD"
                : jobName.includes("PD")  ? "学振PD"  : 'その他';
      }
      return jobName;
    },
    getGrantName(grant) {
      let grantName = '';
      if('category' in grant) {
        grantName = grant.category.ja;
      }
      if(grantName == '' && 'system_name' in grant) {
        grantName = grant.system_name.ja;
      }
      return grantName;
    },
    plotCareerHistory() {
      // set CSS property
      document.documentElement.style.setProperty('--col-width', this.chart.setting.cellWidth + "px");
      // Education and Job History
      for(let i=0; i<this.career.educationsAndJobs.length; i++) {
        let newItem = this.getEducationAndJobItem(this.career.educationsAndJobs[i]);
        if(this.chart.educationsAndJobs.length == 0) {
          this.chart.educationsAndJobs.push([newItem]);
        } else {
          for(let j=0; j<this.chart.educationsAndJobs.length; j++) {
            if(this.chart.educationsAndJobs[j][0].from > newItem.to) {
              this.chart.educationsAndJobs[j].unshift(newItem);
              break;
            } else if(this.chart.educationsAndJobs[j][this.chart.educationsAndJobs[j].length-1].to < newItem.from) {
              this.chart.educationsAndJobs[j].push(newItem);
              break;
            } else if(j == this.chart.educationsAndJobs.length - 1) {
              this.chart.educationsAndJobs.push([newItem]);
              break;
            }
          }
        }
      }
      // Grant History
      for(let i=0; i<this.career.grants.length; i++) {
        let newItem = this.getGrantItem(this.career.grants[i]);
        if(this.chart.grants.length == 0) {
          this.chart.grants.push([newItem]);
        } else {
          for(let j=0; j<this.chart.grants.length; j++) {
            if(this.chart.grants[j][0].from > newItem.to) {
              this.chart.grants[j].unshift(newItem);
              break;
            } else if(this.chart.grants[j][this.chart.grants[j].length-1].to < newItem.from) {
              this.chart.grants[j].push(newItem);
              break;
            } else if(j == this.chart.grants.length - 1) {
              this.chart.grants.push([newItem]);
              break;
            }
          }
        }
      }
      // Achievement History (paper)
      achievementTypeList = ['journal', 'intlConf', 'domesticConf'];
      for(let achvmntType of achievementTypeList) {
        this.chart.achievements[achvmntType] = {};
        for(let i=this.career.firstYear; i<=this.career.latestYear; i++) {
          let year = String(i);
          if(year in this.career.achievements[achvmntType]) {
            let achvmnt = this.career.achievements[achvmntType][year];
            let firstCorrespCount = achvmnt.firstCorresp + achvmnt.first + achvmnt.corresp;
            this.chart.achievements[achvmntType][year] = Array(firstCorrespCount).fill(1).concat(Array(achvmnt.other).fill(0));
          } else {
            this.chart.achievements[achvmntType][year] = [];
          }
        }
      }
    },
    getEducationAndJobItem(item) {
      return {
        from:  parseFloat((item.yearFrom.year + item.yearFrom.month / 12.0).toFixed(2)),
        to:    parseFloat((item.yearTo.year   + item.yearTo.month   / 12.0).toFixed(2)),
        name:  item.name,
        isEdu: item.isEdu,
      };
    },
    getGrantItem(item) {
      return {
        from: parseFloat((item.yearFrom.year + item.yearFrom.month / 12.0).toFixed(2)),
        to:   parseFloat((item.yearTo.year   + item.yearTo.month   / 12.0).toFixed(2)),
        name: item.name,
        isPI: item.role == 'principal',
      };
    },
    getStackCellStyle(item) {
      return {
        width: (this.chart.setting.cellWidth * (item.to - item.from)) + 'px',
        left: (this.chart.setting.cellWidth * (item.from - this.career.firstYear)) + 'px'
      };
    }
  },
  computed: {
  }
});
</script>
</html>